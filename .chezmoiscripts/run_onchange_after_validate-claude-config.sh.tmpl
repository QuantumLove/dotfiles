#!/bin/bash
set -e

echo "üîç Validating Claude Code configuration..."

# Check Claude Code is installed (but don't install it)
if ! command -v claude &> /dev/null; then
    echo "‚ö†Ô∏è  Claude Code not found. Please install it manually:"
    echo ""
    {{- if .is_macos }}
    echo "   macOS: brew install claude-code"
    {{- else if .is_devcontainer }}
    echo "   DevContainer: Add to devcontainer.json:"
    echo '   "features": { "ghcr.io/anthropics/devcontainer-features/claude-code:1": {} }'
    {{- else }}
    echo "   Linux: npm install -g @anthropics/claude-code"
    {{- end }}
    echo ""
    exit 1
fi

echo "‚úÖ Claude Code found: $(claude --version)"

# Validate directory structure
if [ ! -d ~/.claude ]; then
    echo "‚ùå ~/.claude directory missing"
    exit 1
fi

if [ ! -d ~/.claude/agents ]; then
    echo "‚ùå ~/.claude/agents directory missing"
    exit 1
fi

if [ ! -d ~/.claude/commands ]; then
    echo "‚ùå ~/.claude/commands directory missing"
    exit 1
fi

echo "‚úÖ Directory structure valid"

# Validate core files exist
REQUIRED_FILES=(
    "~/.claude/settings.json"
    "~/.claude/mcp.json"
    "~/.claude/status-line.sh"
)

for file in "${REQUIRED_FILES[@]}"; do
    expanded_file=$(eval echo "$file")
    if [ ! -f "$expanded_file" ]; then
        echo "‚ùå Required file missing: $file"
        exit 1
    fi
done

echo "‚úÖ Core configuration files present"

# Validate JSON files
if command -v jq &> /dev/null; then
    if ! jq empty ~/.claude/settings.json 2>/dev/null; then
        echo "‚ùå settings.json is not valid JSON"
        exit 1
    fi

    if ! jq empty ~/.claude/mcp.json 2>/dev/null; then
        echo "‚ùå mcp.json is not valid JSON"
        exit 1
    fi

    echo "‚úÖ JSON configuration files are valid"
else
    echo "‚ö†Ô∏è  jq not found, skipping JSON validation"
fi

# Count agents and commands
AGENT_COUNT=$(find ~/.claude/agents -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
COMMAND_COUNT=$(find ~/.claude/commands -name "*.md" 2>/dev/null | wc -l | tr -d ' ')

echo "‚úÖ Found $AGENT_COUNT agents"
echo "‚úÖ Found $COMMAND_COUNT commands"

# Validate agents have proper frontmatter
INVALID_AGENTS=0
for agent in ~/.claude/agents/*.md; do
    if [ -f "$agent" ]; then
        if ! grep -q "^name:" "$agent" || ! grep -q "^description:" "$agent"; then
            echo "‚ö†Ô∏è  Invalid frontmatter in $(basename "$agent")"
            INVALID_AGENTS=$((INVALID_AGENTS + 1))
        fi
    fi
done

# Validate commands have proper frontmatter
INVALID_COMMANDS=0
for command in ~/.claude/commands/*.md; do
    if [ -f "$command" ]; then
        if ! grep -q "^name:" "$command"; then
            echo "‚ö†Ô∏è  Invalid frontmatter in $(basename "$command")"
            INVALID_COMMANDS=$((INVALID_COMMANDS + 1))
        fi
    fi
done

if [ $INVALID_AGENTS -gt 0 ] || [ $INVALID_COMMANDS -gt 0 ]; then
    echo "‚ö†Ô∏è  Found $INVALID_AGENTS invalid agents and $INVALID_COMMANDS invalid commands"
    echo "    Claude Code may not load these correctly"
fi

echo ""
echo "‚úÖ Claude Code configuration validation complete"
echo "   Agents: $AGENT_COUNT"
echo "   Commands: $COMMAND_COUNT"
echo "   Environment: {{ if .is_devcontainer }}DevContainer{{ else if .is_macos }}macOS{{ else }}Linux{{ end }}"
