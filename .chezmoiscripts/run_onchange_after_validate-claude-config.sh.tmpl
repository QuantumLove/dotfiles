#!/bin/bash
# Fast validation of Claude Code configuration
# For full diagnostics, run: /claude-diagnostics
set -e

echo ""
echo "üîç Claude Code - Quick Validation"
echo ""

WARN_COUNT=0
warn() { echo "‚ö†Ô∏è  $1"; WARN_COUNT=$((WARN_COUNT + 1)); }

# ----------------------------------------
# REQUIRED: Claude CLI
# ----------------------------------------
if ! command -v claude &> /dev/null; then
    echo "‚ùå Claude Code not found. Please install it:"
    {{- if .is_macos }}
    echo "   macOS: brew install claude-code"
    {{- else if .is_devcontainer }}
    echo "   DevContainer: Add to devcontainer.json:"
    echo '   "features": { "ghcr.io/anthropics/devcontainer-features/claude-code:1": {} }'
    {{- else }}
    echo "   Linux: npm install -g @anthropics/claude-code"
    {{- end }}
    exit 1
fi
echo "‚úÖ claude: $(claude --version 2>&1 | head -1)"

# ----------------------------------------
# REQUIRED: Git
# ----------------------------------------
if ! command -v git &> /dev/null; then
    echo "‚ùå git not found (required)"
    exit 1
fi

# ----------------------------------------
# REQUIRED: jq (hooks need it)
# ----------------------------------------
if ! command -v jq &> /dev/null; then
    warn "jq not found - hooks may not work correctly"
fi

# ----------------------------------------
# REQUIRED: Directory structure
# ----------------------------------------
for dir in ~/.claude ~/.claude/agents ~/.claude/commands; do
    if [ ! -d "$dir" ]; then
        echo "‚ùå $dir missing"
        exit 1
    fi
done
echo "‚úÖ directories exist"

# ----------------------------------------
# REQUIRED: Valid settings.json
# ----------------------------------------
if [ ! -f ~/.claude/settings.json ]; then
    echo "‚ùå settings.json missing"
    exit 1
fi
if command -v jq &> /dev/null && ! jq empty ~/.claude/settings.json 2>/dev/null; then
    echo "‚ùå settings.json is not valid JSON"
    exit 1
fi
echo "‚úÖ settings.json valid"

# ----------------------------------------
# COUNT: Agents and commands
# ----------------------------------------
AGENT_COUNT=$(find ~/.claude/agents -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
COMMAND_COUNT=$(find ~/.claude/commands -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
echo "‚úÖ $AGENT_COUNT agents, $COMMAND_COUNT commands"

# ----------------------------------------
# VALIDATE: Frontmatter (fast check)
# ----------------------------------------
# Agents need both name: and description:
INVALID_AGENTS=$(grep -L "^name:" ~/.claude/agents/*.md 2>/dev/null | wc -l | tr -d ' ')
if [ "$INVALID_AGENTS" -gt 0 ]; then
    warn "$INVALID_AGENTS agent(s) missing 'name:' frontmatter"
fi

# Commands need name:
INVALID_COMMANDS=$(grep -L "^name:" ~/.claude/commands/*.md 2>/dev/null | wc -l | tr -d ' ')
if [ "$INVALID_COMMANDS" -gt 0 ]; then
    warn "$INVALID_COMMANDS command(s) missing 'name:' frontmatter"
fi

# ----------------------------------------
# OPTIONAL: Quick checks (non-blocking)
# ----------------------------------------
{{- if .is_macos }}
if ! command -v terminal-notifier &> /dev/null; then
    warn "terminal-notifier not found - notifications won't work"
fi
{{- end }}

if ! command -v gh &> /dev/null || ! gh auth status &>/dev/null 2>&1; then
    warn "gh CLI not authenticated - run 'gh auth login'"
fi

# ----------------------------------------
# SUMMARY
# ----------------------------------------
echo ""
if [ $WARN_COUNT -gt 0 ]; then
    echo "‚ö†Ô∏è  $WARN_COUNT warning(s) - run /claude-diagnostics for details"
else
    echo "‚úÖ All checks passed"
fi
echo ""
