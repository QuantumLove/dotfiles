#!/bin/bash
# Declaratively manage MCP servers in ~/.claude.json
# This script merges our MCP server configs while preserving all other data.
# Hash: {{ include "private_dot_claude/mcp-servers.yaml" | sha256sum }}
set -euo pipefail

# Read current file from stdin
current="$(cat)"

# If file doesn't exist or is empty, start with minimal structure
if [ -z "$current" ] || [ "$current" = "{}" ]; then
    current='{"mcpServers":{}}'
fi

# Load LINEAR_API_KEY from 1Password if not already set
if [ -z "${LINEAR_API_KEY:-}" ] && command -v op &> /dev/null; then
    LINEAR_API_KEY=$(op read "op://Development/Linear MCP API Key/credential" 2>/dev/null || echo "")
fi

# Load SENTRY_ACCESS_TOKEN from 1Password if not already set
if [ -z "${SENTRY_ACCESS_TOKEN:-}" ] && command -v op &> /dev/null; then
    SENTRY_ACCESS_TOKEN=$(op read "op://Development/Sentry MCP API Key/credential" 2>/dev/null || echo "")
fi

# Define our MCP servers (source of truth)
mcp_servers='{{ include "private_dot_claude/mcp-servers.yaml" | sha256sum }}'
desired_servers='{
  "linear": {
    "type": "stdio",
    "command": "npx",
    "args": ["-y", "@larryhudson/linear-mcp-server"],
    "env": {
      "LINEAR_API_KEY": "'"${LINEAR_API_KEY:-}"'"
    }
  },
  "fetch": {
    "type": "stdio",
    "command": "uvx",
    "args": ["mcp-server-fetch"],
    "env": {}
  },
  "pypi-query": {
    "type": "stdio",
    "command": "uvx",
    "args": ["--from", "pypi-query-mcp-server", "pypi-query-mcp"],
    "env": {
      "PYPI_INDEX_URL": "https://pypi.org/pypi",
      "PYPI_CACHE_TTL": "3600"
    }
  },
  "sentry": {
    "type": "stdio",
    "command": "npx",
    "args": ["@sentry/mcp-server@latest"],
    "env": {
      "SENTRY_ACCESS_TOKEN": "'"${SENTRY_ACCESS_TOKEN:-}"'"
    }
  }
}'

# Merge our servers into existing mcpServers (preserves any user-added servers)
echo "$current" | jq --argjson servers "$desired_servers" '
  .mcpServers = ((.mcpServers // {}) * $servers)
'
