#!/bin/bash
# Declaratively manage MCP servers in ~/.claude.json
# This script merges our MCP server configs while preserving all other data.
# Hash: {{ include "private_dot_claude/mcp-servers.yaml" | sha256sum }}
set -euo pipefail

# Read current file from stdin
current="$(cat)"

# If file doesn't exist or is empty, start with minimal structure
if [ -z "$current" ] || [ "$current" = "{}" ]; then
    current='{"mcpServers":{}}'
fi

# Load secrets from 1Password if op CLI available
if command -v op &> /dev/null; then
    # Linear
    if [ -z "${LINEAR_API_KEY:-}" ]; then
        LINEAR_API_KEY=$(op read "op://Development/Linear MCP API Key/credential" 2>/dev/null || echo "")
    fi
    # Sentry
    if [ -z "${SENTRY_ACCESS_TOKEN:-}" ]; then
        SENTRY_ACCESS_TOKEN=$(op read "op://Development/Sentry MCP API Key/credential" 2>/dev/null || echo "")
    fi
    # GitHub
    if [ -z "${GITHUB_PERSONAL_ACCESS_TOKEN:-}" ]; then
        GITHUB_PERSONAL_ACCESS_TOKEN=$(op read "op://Development/GitHub Personal Access Token/credential" 2>/dev/null || echo "")
    fi
    # Toggl
    if [ -z "${TOGGL_API_KEY:-}" ]; then
        TOGGL_API_KEY=$(op read "op://Development/Toggl API Key/credential" 2>/dev/null || echo "")
    fi
    # Notion - DISABLED (no permission to create integration)
    # if [ -z "${NOTION_API_KEY:-}" ]; then
    #     NOTION_API_KEY=$(op read "op://Development/Notion API Key/credential" 2>/dev/null || echo "")
    # fi
    # Slack (User Token - acts as you)
    if [ -z "${SLACK_MCP_XOXP_TOKEN:-}" ]; then
        SLACK_MCP_XOXP_TOKEN=$(op read "op://Development/Slack User Token/credential" 2>/dev/null || echo "")
    fi
fi

# Define our MCP servers (source of truth)
mcp_servers='{{ include "private_dot_claude/mcp-servers.yaml" | sha256sum }}'
desired_servers='{
  "linear": {
    "type": "stdio",
    "command": "npx",
    "args": ["-y", "@larryhudson/linear-mcp-server"],
    "env": {
      "LINEAR_API_KEY": "'"${LINEAR_API_KEY:-}"'"
    }
  },
  "fetch": {
    "type": "stdio",
    "command": "uvx",
    "args": ["mcp-server-fetch"],
    "env": {}
  },
  "pypi-query": {
    "type": "stdio",
    "command": "uvx",
    "args": ["--from", "pypi-query-mcp-server", "pypi-query-mcp"],
    "env": {
      "PYPI_INDEX_URL": "https://pypi.org/pypi",
      "PYPI_CACHE_TTL": "3600"
    }
  },
  "sentry": {
    "type": "stdio",
    "command": "npx",
    "args": ["@sentry/mcp-server@latest"],
    "env": {
      "SENTRY_ACCESS_TOKEN": "'"${SENTRY_ACCESS_TOKEN:-}"'",
      "SENTRY_ORG": "metr-sh"
    }
  },
  "github": {
    "type": "stdio",
    "command": "npx",
    "args": ["-y", "@modelcontextprotocol/server-github"],
    "env": {
      "GITHUB_PERSONAL_ACCESS_TOKEN": "'"${GITHUB_PERSONAL_ACCESS_TOKEN:-}"'"
    }
  },
  "toggl": {
    "type": "stdio",
    "command": "npx",
    "args": ["-y", "@verygoodplugins/mcp-toggl@latest"],
    "env": {
      "TOGGL_API_KEY": "'"${TOGGL_API_KEY:-}"'"
    }
  },
  "slack": {
    "type": "stdio",
    "command": "npx",
    "args": ["-y", "slack-mcp-server"],
    "env": {
      "SLACK_MCP_XOXP_TOKEN": "'"${SLACK_MCP_XOXP_TOKEN:-}"'",
      "SLACK_MCP_ADD_MESSAGE_TOOL": "true"
    }
  }
}'

# Merge our servers into existing mcpServers (preserves any user-added servers)
echo "$current" | jq --argjson servers "$desired_servers" '
  .mcpServers = ((.mcpServers // {}) * $servers)
'
