#!/bin/bash
# Clone Claude Code plugin marketplaces if not present
# This script runs once after chezmoi apply

set -e

PLUGINS_DIR="$HOME/.claude/plugins/marketplaces"
mkdir -p "$PLUGINS_DIR"

echo "ğŸ”Œ Installing Claude Code plugins..."
echo ""

clone_if_missing() {
  local name="$1"
  local repo="$2"
  if [ ! -d "$PLUGINS_DIR/$name" ]; then
    echo "ğŸ“¦ Cloning $name..."
    git clone --depth 1 "https://github.com/$repo.git" "$PLUGINS_DIR/$name" 2>/dev/null
    echo "   âœ… Installed"
  else
    echo "âœ… $name already installed"
  fi
}

clone_if_missing "claude-plugins-official" "anthropics/claude-plugins-official"
clone_if_missing "compound-engineering-plugin" "EveryInc/compound-engineering-plugin"
clone_if_missing "superpowers-marketplace" "obra/superpowers-marketplace"

echo ""
echo "ğŸ“¥ Installing plugins from marketplaces..."

# Install plugins via CLI (populates cache)
install_plugin() {
  local plugin="$1"
  if command -v claude &> /dev/null; then
    echo "   Installing $plugin..."
    claude plugin install "$plugin" 2>/dev/null || echo "   âš ï¸  $plugin may already be installed"
  fi
}

install_plugin "compound-engineering"
install_plugin "superpowers@superpowers-marketplace"

echo ""
echo "ğŸ‰ Claude Code plugins ready!"
echo "   Restart Claude Code to use new plugins."
