---
name: claude-backup
description: Backup and restore Claude Code configuration
---

# Claude Backup Command

Backup and restore your Claude Code configuration, including custom agents, commands, and settings.

## Usage

```bash
/claude-backup                    # Create timestamped backup
/claude-backup --name my-backup   # Create named backup
/claude-backup --list             # List available backups
/claude-backup --restore latest   # Restore most recent backup
/claude-backup --restore NAME     # Restore specific backup
/claude-backup --clean            # Remove old backups (keep last 5)
```

## What Gets Backed Up

### Always Included
- `~/.claude/` directory (all configurations)
- Custom agents, commands, skills
- Settings and MCP configuration
- Learning logs and todos

### Optionally Included
- Shell configurations (`.zshrc`, `.bashrc`)
- Warp configurations
- chezmoi source directory reference

### Never Included
- Credentials (handled by 1Password)
- Temporary files
- Cache directories

## Implementation

```bash
#!/bin/bash
set -euo pipefail

ACTION="${1:-backup}"
NAME="${2:-}"
BACKUP_DIR="$HOME/.claude-backups"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Ensure backup directory exists
mkdir -p "$BACKUP_DIR"

case "$ACTION" in
    backup|--backup)
        # Determine backup name
        if [ -n "$NAME" ] && [ "$NAME" != "--name" ]; then
            BACKUP_NAME="$NAME"
        elif [ "$2" = "--name" ] && [ -n "${3:-}" ]; then
            BACKUP_NAME="$3"
        else
            BACKUP_NAME="claude-backup-$TIMESTAMP"
        fi

        BACKUP_PATH="$BACKUP_DIR/$BACKUP_NAME"

        echo -e "${BLUE}ðŸ—„ï¸  Creating Claude Code backup${NC}"
        echo "Backup name: $BACKUP_NAME"
        echo ""

        # Create backup
        mkdir -p "$BACKUP_PATH"

        # Backup core configuration
        echo "Backing up core configuration..."
        if [ -d ~/.claude ]; then
            cp -r ~/.claude "$BACKUP_PATH/"
            echo "  âœ… ~/.claude"
        fi

        # Backup metadata
        cat > "$BACKUP_PATH/metadata.json" <<EOF
{
  "timestamp": "$TIMESTAMP",
  "name": "$BACKUP_NAME",
  "claude_version": "$(claude --version 2>/dev/null | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+' || echo 'unknown')",
  "host": "$(hostname)",
  "user": "$USER",
  "chezmoi_source": "$(chezmoi source-path 2>/dev/null || echo 'N/A')"
}
EOF

        # Create restore script
        cat > "$BACKUP_PATH/restore.sh" <<'EOF'
#!/bin/bash
# Claude Code Backup Restore Script
set -euo pipefail

BACKUP_DIR="$(dirname "$0")"

echo "ðŸ”„ Restoring Claude Code configuration..."

# Backup current config
if [ -d ~/.claude ]; then
    mv ~/.claude ~/.claude.before-restore
    echo "  Current config moved to ~/.claude.before-restore"
fi

# Restore
cp -r "$BACKUP_DIR/.claude" ~/
echo "  âœ… Configuration restored"

echo ""
echo "âœ… Restore complete!"
echo ""
echo "ðŸ’¡ Next steps:"
echo "1. Reload your shell: exec \$SHELL"
echo "2. Validate setup: /claude-validate"
echo "3. If issues occur, previous config is at ~/.claude.before-restore"
EOF
        chmod +x "$BACKUP_PATH/restore.sh"

        # Calculate size
        SIZE=$(du -sh "$BACKUP_PATH" | cut -f1)

        echo ""
        echo -e "${GREEN}âœ… Backup complete!${NC}"
        echo "Location: $BACKUP_PATH"
        echo "Size: $SIZE"
        echo ""
        echo "To restore this backup later:"
        echo "  /claude-backup --restore $BACKUP_NAME"
        ;;

    --list)
        echo -e "${BLUE}ðŸ“¦ Available Claude Code backups${NC}"
        echo ""

        if [ -z "$(ls -A "$BACKUP_DIR" 2>/dev/null)" ]; then
            echo "No backups found."
            exit 0
        fi

        # List backups with metadata
        for backup in "$BACKUP_DIR"/*; do
            if [ -d "$backup" ]; then
                NAME=$(basename "$backup")
                if [ -f "$backup/metadata.json" ]; then
                    TIMESTAMP=$(jq -r '.timestamp' "$backup/metadata.json" 2>/dev/null || echo "unknown")
                    VERSION=$(jq -r '.claude_version' "$backup/metadata.json" 2>/dev/null || echo "unknown")
                    SIZE=$(du -sh "$backup" | cut -f1)
                    echo -e "${YELLOW}$NAME${NC}"
                    echo "  Created: $TIMESTAMP"
                    echo "  Version: $VERSION"
                    echo "  Size: $SIZE"
                    echo ""
                else
                    echo -e "${YELLOW}$NAME${NC} (no metadata)"
                    echo ""
                fi
            fi
        done
        ;;

    --restore)
        if [ -z "$NAME" ]; then
            echo -e "${RED}Error: Backup name required${NC}"
            echo "Usage: /claude-backup --restore NAME"
            echo "       /claude-backup --restore latest"
            exit 1
        fi

        # Handle 'latest' keyword
        if [ "$NAME" = "latest" ]; then
            RESTORE_PATH=$(ls -dt "$BACKUP_DIR"/* 2>/dev/null | head -1)
            if [ -z "$RESTORE_PATH" ]; then
                echo -e "${RED}No backups found${NC}"
                exit 1
            fi
        else
            RESTORE_PATH="$BACKUP_DIR/$NAME"
        fi

        if [ ! -d "$RESTORE_PATH" ]; then
            echo -e "${RED}Backup not found: $NAME${NC}"
            echo "Use '/claude-backup --list' to see available backups"
            exit 1
        fi

        echo -e "${BLUE}ðŸ”„ Restoring Claude Code backup${NC}"
        echo "Backup: $(basename "$RESTORE_PATH")"
        echo ""

        # Show metadata if available
        if [ -f "$RESTORE_PATH/metadata.json" ]; then
            echo "Backup details:"
            jq . "$RESTORE_PATH/metadata.json"
            echo ""
        fi

        read -p "Continue with restore? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            if [ -f "$RESTORE_PATH/restore.sh" ]; then
                bash "$RESTORE_PATH/restore.sh"
            else
                # Manual restore for old backups
                [ -d ~/.claude ] && mv ~/.claude ~/.claude.before-restore
                cp -r "$RESTORE_PATH/.claude" ~/
                echo -e "${GREEN}âœ… Restore complete!${NC}"
            fi
        else
            echo "Restore cancelled."
        fi
        ;;

    --clean)
        echo -e "${BLUE}ðŸ§¹ Cleaning old backups${NC}"
        echo "Keeping the 5 most recent backups..."
        echo ""

        # Get list of backups sorted by modification time
        BACKUPS=($(ls -dt "$BACKUP_DIR"/* 2>/dev/null || true))
        COUNT=${#BACKUPS[@]}

        if [ $COUNT -le 5 ]; then
            echo "Only $COUNT backups found. Nothing to clean."
            exit 0
        fi

        # Remove old backups
        REMOVED=0
        for ((i=5; i<$COUNT; i++)); do
            BACKUP="${BACKUPS[$i]}"
            if [ -d "$BACKUP" ]; then
                echo "Removing: $(basename "$BACKUP")"
                rm -rf "$BACKUP"
                ((REMOVED++))
            fi
        done

        echo ""
        echo -e "${GREEN}âœ… Removed $REMOVED old backups${NC}"
        ;;

    *)
        echo -e "${RED}Unknown action: $ACTION${NC}"
        echo ""
        echo "Usage:"
        echo "  /claude-backup                    # Create backup"
        echo "  /claude-backup --name NAME        # Named backup"
        echo "  /claude-backup --list             # List backups"
        echo "  /claude-backup --restore NAME     # Restore backup"
        echo "  /claude-backup --clean            # Remove old backups"
        exit 1
        ;;
esac
```

## Backup Strategy

### Recommended Schedule
- **Before major updates**: Always backup before running `/claude-update`
- **Weekly**: Automated backup via cron/launchd
- **Before experiments**: When trying new configurations

### Automated Backups

Add to crontab (Linux) or launchd (macOS):
```bash
# Weekly backup on Sundays at 2 AM
0 2 * * 0 /usr/local/bin/claude /claude-backup --name weekly-auto

# Clean old backups monthly
0 3 1 * * /usr/local/bin/claude /claude-backup --clean
```

## Recovery Scenarios

### Corrupted Configuration
```bash
# Restore latest working backup
/claude-backup --restore latest

# Validate
/claude-validate
```

### After Failed Update
```bash
# List backups to find pre-update version
/claude-backup --list

# Restore specific backup
/claude-backup --restore claude-backup-20240115-093000
```

### Complete Reset
```bash
# Remove everything and restore from chezmoi
rm -rf ~/.claude
chezmoi apply

# Or restore from backup
/claude-backup --restore latest
```

## Notes

- Backups are stored in `~/.claude-backups/`
- Each backup includes a restore script
- Credentials are never backed up (use 1Password)
- Old configuration is preserved during restore