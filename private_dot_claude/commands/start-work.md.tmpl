---
name: start-work
description: Quick workflow setup for small changes (worktree + issue + branch)
permissions:
  - Bash(git worktree add *)
  - Bash(git worktree list)
  - Bash(git fetch *)
  - Bash(git branch *)
  - Read(**/*.json)
  - mcp__linear__create_issue
  - mcp__linear__get_issue
  - mcp__github__create_branch
---

# Start Work - Quick Workflow Setup

Streamlined command for starting work on a small change with proper isolation and tracking.

## Usage

```bash
# Interactive mode - prompts for options
/start-work

# Load existing Linear issue (creates new branch)
/start-work METR-123

# Resume work on existing branch (tracks remote branch)
/start-work --branch METR-123/fix-auth-timeout

# Resume work from existing PR
/start-work --pr 456
/start-work #456

# Create new Linear issue
/start-work --new "Fix authentication timeout bug"

# Quick mode - no Linear tracking
/start-work --quick "experiment-oauth-flow"

# With team assignment
/start-work --new "Add rate limiting" --team Platform --assign @me
```

## What It Does

**Full Flow:**
1. Verifies current repo is clean (no uncommitted changes)
2. Fetches latest from origin
3. **If existing issue:** Loads issue details via MCP (Linear or GitHub)
4. **If --branch flag:** Tracks existing remote branch (no new branch created)
5. **If --pr flag or #N:** Gets branch from PR, tracks it
6. **If --new flag:** Creates new Linear issue with provided title
7. **If --quick flag:** Skips Linear entirely
8. Creates worktree: `~/code/worktrees/{repo}/{issue-id}`
9. Creates or tracks branch
10. Starts DevContainer and writes handoff file
11. Provides instructions to continue in DevContainer

## Implementation

```bash
#!/bin/bash
set -euo pipefail

# Parse arguments
MODE="interactive"
ISSUE_ID=""
TITLE=""
TEAM=""
ASSIGN=""
QUICK=false
EXISTING_BRANCH=""
PR_NUMBER=""

while [[ $# -gt 0 ]]; do
  case $1 in
    --new)
      MODE="create"
      TITLE="$2"
      shift 2
      ;;
    --quick)
      QUICK=true
      TITLE="${2:-quick-fix}"
      shift 2
      ;;
    --team)
      TEAM="$2"
      shift 2
      ;;
    --assign)
      ASSIGN="$2"
      shift 2
      ;;
    --branch)
      MODE="existing-branch"
      EXISTING_BRANCH="$2"
      shift 2
      ;;
    --pr)
      MODE="pr"
      PR_NUMBER="$2"
      shift 2
      ;;
    \#*)
      # Handle #123 format for PR
      MODE="pr"
      PR_NUMBER="${1#\#}"
      shift
      ;;
    *)
      ISSUE_ID="$1"
      MODE="existing"
      shift
      ;;
  esac
done

# Verify in git repo
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "âŒ Not in a git repository"
  exit 1
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD -- 2>/dev/null; then
  echo "âŒ You have uncommitted changes. Commit or stash them first."
  git status --short
  exit 1
fi

REPO_NAME=$(basename $(git rev-parse --show-toplevel))
WORKTREE_BASE="$HOME/code/worktrees/$REPO_NAME"
mkdir -p "$WORKTREE_BASE"

# Fetch latest
echo "ğŸ“¡ Fetching latest from origin..."
git fetch origin

# Handle PR mode - get branch from PR
if [ "$MODE" = "pr" ]; then
  echo "ğŸ” Looking up PR #$PR_NUMBER..."
  PR_JSON=$(gh pr view "$PR_NUMBER" --json headRefName,title,number,state 2>/dev/null || echo "{}")
  if [ "$PR_JSON" = "{}" ] || [ "$(echo "$PR_JSON" | jq -r '.headRefName')" = "null" ]; then
    echo "âŒ Could not find PR #$PR_NUMBER"
    exit 1
  fi
  EXISTING_BRANCH=$(echo "$PR_JSON" | jq -r '.headRefName')
  PR_TITLE=$(echo "$PR_JSON" | jq -r '.title')
  echo "   PR: #$PR_NUMBER - $PR_TITLE"
  echo "   Branch: $EXISTING_BRANCH"
  MODE="existing-branch"
fi

# Handle existing branch mode
if [ "$MODE" = "existing-branch" ]; then
  # Check if branch exists on remote
  if ! git show-ref --verify --quiet "refs/remotes/origin/$EXISTING_BRANCH"; then
    echo "âŒ Branch 'origin/$EXISTING_BRANCH' not found"
    echo "   Available branches:"
    git branch -r | grep -v HEAD | head -10
    exit 1
  fi

  # Extract issue ID from branch name if possible (e.g., METR-123/fix-thing)
  if [[ "$EXISTING_BRANCH" =~ ^([A-Z]+-[0-9]+) ]]; then
    ISSUE_ID="${BASH_REMATCH[1]}"
    WORKTREE_NAME="$ISSUE_ID"
  else
    # Use branch name as worktree name
    WORKTREE_NAME=$(echo "$EXISTING_BRANCH" | sed 's/[^a-zA-Z0-9-]/-/g' | sed 's/--*/-/g')
  fi
  WORKTREE_PATH="$WORKTREE_BASE/$WORKTREE_NAME"
  BRANCH_NAME="$EXISTING_BRANCH"
  TRACK_EXISTING=true

  echo "ğŸ“‹ Using existing branch: $EXISTING_BRANCH"
fi

# Handle different modes
if [ "$MODE" = "interactive" ]; then
  echo "ğŸš€ Start Work - Quick Setup"
  echo ""
  echo "Choose an option:"
  echo "  1) Load existing Linear issue"
  echo "  2) Create new Linear issue"
  echo "  3) Quick mode (no issue tracking)"
  read -p "Selection (1-3): " choice

  case $choice in
    1)
      read -p "Linear issue ID (e.g., METR-123): " ISSUE_ID
      MODE="existing"
      ;;
    2)
      read -p "Issue title: " TITLE
      read -p "Team (optional): " TEAM
      MODE="create"
      ;;
    3)
      read -p "Branch name slug: " TITLE
      QUICK=true
      ;;
    *)
      echo "Invalid choice"
      exit 1
      ;;
  esac
fi

# Process based on mode (skip if existing-branch already set)
if [ "${TRACK_EXISTING:-}" = "true" ]; then
  : # Already configured above
elif [ "$QUICK" = true ]; then
  # Quick mode - no Linear
  SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | sed 's/[^a-z0-9-]//g')
  BRANCH_NAME="quick/$SLUG"
  WORKTREE_NAME="quick-${SLUG}"
  WORKTREE_PATH="$WORKTREE_BASE/$WORKTREE_NAME"

  echo "âš¡ Quick mode - skipping Linear"

elif [ "$MODE" = "existing" ]; then
  # Load existing issue
  echo "ğŸ“‹ Loading issue $ISSUE_ID..."

  # Use MCP to fetch issue details
  ISSUE_JSON=$(claude mcp call linear get_issue --issue-id "$ISSUE_ID" 2>/dev/null || echo "{}")

  if [ "$ISSUE_JSON" = "{}" ]; then
    echo "âŒ Could not load issue $ISSUE_ID"
    exit 1
  fi

  ISSUE_TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
  ISSUE_STATE=$(echo "$ISSUE_JSON" | jq -r '.state.name')

  echo "   Title: $ISSUE_TITLE"
  echo "   State: $ISSUE_STATE"

  SLUG=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | sed 's/[^a-z0-9-]//g' | cut -c1-50)
  BRANCH_NAME="$ISSUE_ID/$SLUG"
  WORKTREE_NAME="$ISSUE_ID"
  WORKTREE_PATH="$WORKTREE_BASE/$WORKTREE_NAME"

elif [ "$MODE" = "create" ]; then
  # Create new Linear issue
  echo "ğŸ“ Creating Linear issue: $TITLE"

  TEAM_ARG=""
  if [ -n "$TEAM" ]; then
    TEAM_ARG="--team $TEAM"
  fi

  ASSIGN_ARG=""
  if [ -n "$ASSIGN" ]; then
    ASSIGN_ARG="--assignee $ASSIGN"
  fi

  # Create issue via MCP
  ISSUE_JSON=$(claude mcp call linear create_issue \
    --title "$TITLE" \
    $TEAM_ARG \
    $ASSIGN_ARG \
    2>/dev/null || echo "{}")

  if [ "$ISSUE_JSON" = "{}" ]; then
    echo "âŒ Could not create Linear issue"
    exit 1
  fi

  ISSUE_ID=$(echo "$ISSUE_JSON" | jq -r '.identifier')
  echo "   Created: $ISSUE_ID"

  SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | sed 's/[^a-z0-9-]//g' | cut -c1-50)
  BRANCH_NAME="$ISSUE_ID/$SLUG"
  WORKTREE_NAME="$ISSUE_ID"
  WORKTREE_PATH="$WORKTREE_BASE/$WORKTREE_NAME"
fi

# Check if worktree already exists
if [ -d "$WORKTREE_PATH" ]; then
  echo "âš ï¸  Worktree already exists: $WORKTREE_PATH"
  read -p "Remove and recreate? (yes/no): " confirm
  if [ "$confirm" = "yes" ]; then
    git worktree remove "$WORKTREE_PATH" --force
  else
    echo "Cancelled"
    exit 1
  fi
fi

# Create worktree
echo "ğŸŒ³ Creating worktree: $WORKTREE_NAME"
if [ "${TRACK_EXISTING:-}" = "true" ]; then
  # Track existing remote branch
  git worktree add "$WORKTREE_PATH" "origin/$BRANCH_NAME"
  echo "   (tracking existing branch)"
else
  # Create new branch from origin/main
  git worktree add "$WORKTREE_PATH" -b "$BRANCH_NAME" origin/main
fi

echo ""
echo "âœ… Worktree created!"
echo ""
echo "ğŸ“‚ Worktree: $WORKTREE_PATH"
echo "ğŸŒ¿ Branch: $BRANCH_NAME"
if [ "$QUICK" = false ]; then
  echo "ğŸ« Issue: $ISSUE_ID"
fi

# --- Session Handoff ---
# Write context to handoff file for DevContainer continuation
HANDOFF_DIR="$HOME/.claude/handoff"
mkdir -p "$HANDOFF_DIR"
HANDOFF_FILE="$HANDOFF_DIR/${WORKTREE_NAME}.md"

echo "ğŸ“ Writing session handoff..."

cat > "$HANDOFF_FILE" << HANDOFF_EOF
# Session Handoff: ${ISSUE_ID:-$WORKTREE_NAME}

## Issue Context
HANDOFF_EOF

# Add issue context if available
if [ "$QUICK" = false ] && [ -n "$ISSUE_ID" ]; then
  # Fetch and format issue details
  ISSUE_JSON=$(claude mcp call linear get_issue --issue-id "$ISSUE_ID" 2>/dev/null || echo "{}")
  if [ "$ISSUE_JSON" != "{}" ]; then
    echo "$ISSUE_JSON" | jq -r '"**Title:** \(.title)\n**Status:** \(.state.name)\n**Priority:** \(.priority // "None")\n\n### Description\n\(.description // "No description")\n\n### Acceptance Criteria\n\(.acceptanceCriteria // "None specified")"' >> "$HANDOFF_FILE"
  else
    echo "Issue: $ISSUE_ID (details unavailable)" >> "$HANDOFF_FILE"
  fi
else
  echo "Quick mode - no issue tracking" >> "$HANDOFF_FILE"
fi

cat >> "$HANDOFF_FILE" << HANDOFF_EOF

## Worktree Info
- **Path:** $WORKTREE_PATH
- **Branch:** $BRANCH_NAME
- **Created:** $(date '+%Y-%m-%d %H:%M:%S')

## Next Steps
1. Review the issue context above
2. Explore the codebase to understand the change needed
3. Implement the fix/feature
4. Run tests and verify
5. Use \`/push-pr\` to create a pull request

## How to Continue
Run \`claude\` in this DevContainer terminal to continue work.
Use \`cat ~/.claude/handoff/${WORKTREE_NAME}.md\` to review this context.
HANDOFF_EOF

echo "   Saved to: $HANDOFF_FILE"

# --- Start DevContainer (if available) ---
if [ -f "$WORKTREE_PATH/.devcontainer/devcontainer.json" ]; then
  echo ""
  echo "ğŸ³ Starting DevContainer..."
  cd "$WORKTREE_PATH"
  ~/.claude/skills/worktree/scripts/dev-open-worktree.sh

  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âœ… DevContainer started! Continue work inside."
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "To continue work inside the DevContainer:"
  echo ""
  echo "  Option 1 - Warp/Terminal (recommended):"
  echo "    docker exec -it ${PROJECT}-${BRANCH} claude"
  echo ""
  echo "  Option 2 - VSCode:"
  echo "    Use the integrated terminal in VSCode (already opened)"
  echo ""
  echo "Session context saved to:"
  echo "  ~/.claude/handoff/${WORKTREE_NAME}.md"
  echo ""
  echo "This host session will now end. Continue in DevContainer."
else
  # No DevContainer available
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âœ… Workspace ready!"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "No DevContainer found. Next steps:"
  echo "  1. cd $WORKTREE_PATH"
  echo "  2. Start a new Claude session there: claude"
  echo "  3. Make your changes"
  echo "  4. /push-pr (to create PR)"
  echo ""
  if command -v code &> /dev/null; then
    read -p "Open in VSCode? (yes/no): " open_editor
    if [ "$open_editor" = "yes" ]; then
      code "$WORKTREE_PATH"
    fi
  fi
fi
```

## Examples

### Example 1: Existing Linear Issue

```bash
$ /start-work METR-456

ğŸ“¡ Fetching latest from origin...
ğŸ“‹ Loading issue METR-456...
   Title: Fix timeout in evaluation runner
   State: In Progress
ğŸŒ³ Creating worktree: METR-456

âœ… Worktree created!

ğŸ“‚ Worktree: ~/code/worktrees/inspect-action/METR-456
ğŸŒ¿ Branch: METR-456/fix-timeout-in-evaluation-runner
ğŸ« Issue: METR-456

ğŸ“ Writing session handoff...
   Saved to: ~/.claude/handoff/METR-456.md

ğŸ³ Starting DevContainer...

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… DevContainer started! Continue work inside.
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

To continue work inside the DevContainer:

  Option 1 - Warp/Terminal (recommended):
    docker exec -it inspect-action-METR-456 claude

  Option 2 - VSCode:
    Use the integrated terminal in VSCode (already opened)

This host session will now end. Continue in DevContainer.
```

### Example 2: Existing Branch (Resume Work)

```bash
$ /start-work --branch METR-456/fix-timeout

ğŸ“¡ Fetching latest from origin...
ğŸ“‹ Using existing branch: METR-456/fix-timeout
ğŸŒ³ Creating worktree: METR-456
   (tracking existing branch)

âœ… Worktree created!

ğŸ“‚ Worktree: ~/code/worktrees/inspect-action/METR-456
ğŸŒ¿ Branch: METR-456/fix-timeout
ğŸ« Issue: METR-456

ğŸ“ Writing session handoff...
ğŸ³ Starting DevContainer...

This host session will now end. Continue in DevContainer.
```

### Example 3: From Pull Request

```bash
$ /start-work --pr 456

ğŸ“¡ Fetching latest from origin...
ğŸ” Looking up PR #456...
   PR: #456 - Fix timeout in evaluation runner
   Branch: METR-456/fix-timeout
ğŸ“‹ Using existing branch: METR-456/fix-timeout
ğŸŒ³ Creating worktree: METR-456
   (tracking existing branch)

âœ… Worktree created!
...
```

### Example 4: Quick Mode (No Issue Tracking)

```bash
$ /start-work --quick "test-new-cache-layer"

ğŸ“¡ Fetching latest from origin...
âš¡ Quick mode - skipping Linear
ğŸŒ³ Creating worktree: quick-test-new-cache-layer

âœ… Worktree created!

ğŸ“‚ Worktree: ~/code/worktrees/inspect-action/quick-test-new-cache-layer
ğŸŒ¿ Branch: quick/test-new-cache-layer

ğŸ“ Writing session handoff...
ğŸ³ Starting DevContainer...

This host session will now end. Continue in DevContainer.
```
