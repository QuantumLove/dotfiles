#!/bin/bash
set -e

echo "๐งน Cleanup Worktree"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

ISSUE_ID="$1"
MAIN_REPO="${2:-$HOME/code/metr-repo}"
WORKTREE_BASE="$(dirname "$MAIN_REPO")/$(basename "$MAIN_REPO")-worktrees"
WORKTREE_PATH="$WORKTREE_BASE/issue-$ISSUE_ID"

if [ -z "$ISSUE_ID" ]; then
    echo "Usage: cleanup-worktree.sh <issue-id> [main-repo-path]"
    echo ""
    echo "Examples:"
    echo "  cleanup-worktree.sh METR-123"
    echo "  cleanup-worktree.sh METR-123 ~/code/inspect-action"
    exit 1
fi

# Check if main repo exists
if [ ! -d "$MAIN_REPO" ]; then
    echo "โ Main repository not found: $MAIN_REPO"
    echo "   Specify the correct path as the second argument"
    exit 1
fi

# Check if worktree exists
if [ ! -d "$WORKTREE_PATH" ]; then
    echo "โ๏ธ  Worktree not found: $WORKTREE_PATH"
    echo ""
    echo "Available worktrees:"
    cd "$MAIN_REPO"
    git worktree list
    exit 1
fi

echo "๐ Main repo: $MAIN_REPO"
echo "๐ Worktree:  $WORKTREE_PATH"
echo ""

cd "$MAIN_REPO"

# Check for uncommitted changes
if git -C "$WORKTREE_PATH" status --porcelain | grep -q .; then
    echo "โ๏ธ  WARNING: Worktree has uncommitted changes!"
    echo ""
    git -C "$WORKTREE_PATH" status --short
    echo ""
    read -p "Continue with removal? (y/n): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 0
    fi
fi

# Get branch name before removing worktree
BRANCH_NAME=$(git -C "$WORKTREE_PATH" branch --show-current)

# Remove worktree
echo "๐๏ธ  Removing worktree..."
if git worktree remove "$WORKTREE_PATH" --force; then
    echo "โ Worktree removed"

    # Prune worktree metadata
    git worktree prune

    # Ask about deleting branch
    if [ -n "$BRANCH_NAME" ]; then
        echo ""
        read -p "Delete branch '$BRANCH_NAME'? (y/n): " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            if git branch -d "$BRANCH_NAME" 2>/dev/null; then
                echo "โ Branch deleted: $BRANCH_NAME"
            else
                echo "โ๏ธ  Branch has unmerged changes. Use -D to force delete:"
                echo "   git branch -D $BRANCH_NAME"
            fi
        else
            echo "โญ๏ธ  Branch kept: $BRANCH_NAME"
        fi
    fi

    echo ""
    echo "โ Cleanup complete!"
else
    echo ""
    echo "โ Failed to remove worktree"
    echo ""
    echo "Troubleshooting:"
    echo "  โข Worktree might be locked (another process using it)"
    echo "  โข Try manual removal: git worktree remove --force $WORKTREE_PATH"
    exit 1
fi
