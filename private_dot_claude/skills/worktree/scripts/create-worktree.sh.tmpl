#!/bin/bash
set -e

echo "ğŸŒ³ Create Worktree"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

ISSUE_ID="$1"
BRANCH_NAME="${2:-${ISSUE_ID}/feature}"
MAIN_REPO="${3:-$(pwd)}"
REPO_NAME="$(basename "$MAIN_REPO")"
WORKTREE_BASE="$HOME/code/worktrees/$REPO_NAME"
WORKTREE_PATH="$WORKTREE_BASE/$ISSUE_ID"

if [ -z "$ISSUE_ID" ]; then
    echo "Usage: create-worktree.sh <issue-id> [branch-name] [main-repo-path]"
    echo ""
    echo "Examples:"
    echo "  create-worktree.sh METR-123"
    echo "  create-worktree.sh METR-123 metr-123/fix-auth"
    echo "  create-worktree.sh METR-123 metr-123/fix-auth ~/code/inspect-action"
    exit 1
fi

# Check if main repo exists
if [ ! -d "$MAIN_REPO" ]; then
    echo "âŒ Main repository not found: $MAIN_REPO"
    echo "   Specify the correct path as the third argument"
    exit 1
fi

# Check if worktree already exists
if [ -d "$WORKTREE_PATH" ]; then
    echo "âš ï¸  Worktree already exists: $WORKTREE_PATH"
    read -p "Remove and recreate? (y/n): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        cd "$MAIN_REPO"
        git worktree remove "$WORKTREE_PATH" || true
    else
        echo "Aborted."
        exit 0
    fi
fi

# Create worktree base directory if needed
mkdir -p "$WORKTREE_BASE"

echo "ğŸ“‚ Main repo: $MAIN_REPO"
echo "ğŸ“‚ Worktree:  $WORKTREE_PATH"
echo "ğŸŒ¿ Branch:    $BRANCH_NAME"
echo ""

cd "$MAIN_REPO"

# Fetch latest
echo "ğŸ”„ Fetching latest changes..."
git fetch origin

# Create worktree
echo "ğŸŒ³ Creating worktree..."
if git worktree add "$WORKTREE_PATH" -b "$BRANCH_NAME" origin/main; then
    echo ""
    echo "âœ… Worktree created successfully!"
    echo ""
    echo "Next steps:"
    echo "  cd $WORKTREE_PATH"
    echo "  /dev-open                    # Open DevContainer"
    echo "  /load-issue $ISSUE_ID        # Load Linear issue context"
    echo ""
else
    echo ""
    echo "âŒ Failed to create worktree"
    echo ""
    echo "Troubleshooting:"
    echo "  â€¢ Branch might already exist: git branch -d $BRANCH_NAME"
    echo "  â€¢ Worktree path might exist: rm -rf $WORKTREE_PATH"
    exit 1
fi
