---
name: worktree
description: Git worktree management for parallel development workflows with DevContainer support
tags: [git, workflow, parallel-development, devcontainer]
version: 1.0.0
---

# Git Worktree Management Skill

## Core Problem

Git worktrees allow multiple branches checked out simultaneously, but two issues prevent smooth DevContainer workflows:

1. **The .git File Problem:** In worktrees, `.git` is a FILE (not directory) containing:
   ```
   gitdir: /Users/user/code/metr-repo/.git/worktrees/issue-METR-123
   ```
   This causes DevContainers to fail because the path doesn't exist in the container.

2. **Name Collisions:** Multiple worktrees opening DevContainers with the same hard-coded container name collide.

## Solution: Directory Structure + DevContainer Configuration

**Recommended layout:**
```
~/code/
  inspect-action/           # Main repository (keep on main/stable branch)
  worktrees/
    inspect-action/         # Worktrees for inspect-action
      METR-123/             # Worktree for METR-123
      METR-456/             # Worktree for METR-456
      quick-experiment/     # Quick mode worktree
    mp4-deploy/             # Worktrees for mp4-deploy
      METR-789/             # Worktree for METR-789
```

**Naming Convention:**
- Path: `~/code/worktrees/{repo}/{issue-id}`
- Examples: `~/code/worktrees/inspect-action/METR-123`
- Quick mode: `~/code/worktrees/{repo}/quick-{slug}`

## Key Operations

### Create Worktree for Issue
```bash
# Recommended: Use /start-work command
/start-work METR-123

# Or manually from main repository
cd ~/code/inspect-action
git fetch origin
git worktree add ~/code/worktrees/inspect-action/METR-123 -b METR-123/implement-feature origin/main
```

### DevContainer Configuration for Worktrees

The critical fix - mount the main repo's .git directory:

```json
{
  "name": "METR Development",
  "mounts": [
    "source=${localWorkspaceFolder},target=/workspace,type=bind",
    "source=${localWorkspaceFolder}/../metr-repo/.git,target=/workspace-git,type=bind"
  ],
  "containerEnv": {
    "GIT_DIR": "/workspace-git"
  },
  "postCreateCommand": "git config --global --add safe.directory /workspace"
}
```

This makes git commands work inside DevContainers opened from worktrees.

### Helper Scripts

**File:** `~/.claude/skills/worktree/scripts/create-worktree.sh`

```bash
#!/bin/bash
set -e

ISSUE_ID="$1"
BRANCH_NAME="${2:-${ISSUE_ID}/feature}"
REPO_NAME="$(basename "$(pwd)")"
WORKTREE_BASE="$HOME/code/worktrees/$REPO_NAME"
WORKTREE_PATH="$WORKTREE_BASE/$ISSUE_ID"

if [ -z "$ISSUE_ID" ]; then
    echo "Usage: create-worktree.sh <issue-id> [branch-name]"
    exit 1
fi

git fetch origin
mkdir -p "$WORKTREE_BASE"
git worktree add "$WORKTREE_PATH" -b "$BRANCH_NAME" origin/main

echo "✅ Worktree created: $WORKTREE_PATH"
```

**File:** `~/.claude/skills/worktree/scripts/cleanup-worktree.sh`

```bash
#!/bin/bash
set -e

ISSUE_ID="$1"
REPO_NAME="$(basename "$(pwd)")"
WORKTREE_PATH="$HOME/code/worktrees/$REPO_NAME/$ISSUE_ID"

git worktree remove "$WORKTREE_PATH"
git worktree prune

echo "✅ Worktree cleaned up"
```

## Integration with Commands

### With /start-work
When `/start-work` creates a worktree:
1. Create worktree with standard naming
2. Write session handoff file
3. Start DevContainer
4. Provide continuation instructions

### With /load-issue
When user runs `/load-issue METR-123`, Claude should suggest using `/start-work`:
```bash
# Recommended - full setup with handoff
/start-work METR-123

# Or for existing branch
/start-work --branch METR-123/fix-feature

# Or from PR
/start-work --pr 456
```

### With /dev-open
When opening a DevContainer in a worktree:
1. Check if `.git` is a file (indicates worktree)
2. Verify `.devcontainer/devcontainer.json` has proper mounts
3. Auto-fix configuration if missing
4. Open VS Code with correct DevContainer settings

### With /push-pr
After PR merged, suggest cleanup:
```bash
cd ~/code/inspect-action
git worktree remove ~/code/worktrees/inspect-action/METR-123
git branch -d METR-123/implement-feature
```

## Terminal Tab Naming (Optional)

You can set terminal tab titles using ANSI escape sequences in your shell config:

```bash
# In .zshrc or .bashrc - auto-set tab title to current directory
precmd() { echo -ne "\033]0;${PWD##*/}\007" }

# Or manually set a tab title
set_tab_title() { echo -ne "\033]0;$1\007" }
set_tab_title "METR-123: Fix bug"
```

**Note:** There is no `warp-cli` for tab management. The `warp` CLI is for headless agentic workflows, not terminal control. Tab colors must be set manually (double-click tab → choose color).

## When to Suggest Worktrees

**Suggest when:**
- User is working on multiple Linear issues simultaneously
- User mentions "parallel development" or "multiple features"
- User wants to keep a stable environment while experimenting
- User needs to quickly switch between unrelated tasks

**Don't suggest when:**
- User is only working on one issue at a time
- Simple bug fixes (just use branches)
- Project is very small
- User explicitly prefers traditional branch workflow

## Best Practices

1. **Keep main repo clean** - Never work directly in main repo, only in worktrees
2. **One issue per worktree** - Don't reuse worktrees for multiple issues
3. **Delete after merge** - Clean up worktrees after PR is merged
4. **Consistent naming** - Path: `~/code/worktrees/{repo}/{issue-id}`
5. **Fetch before create** - Always `git fetch origin` before creating worktrees
6. **Use proper removal** - Always use `git worktree remove`, never `rm -rf`
7. **Use /start-work** - It handles worktree creation, DevContainer setup, and handoff

## Troubleshooting

### "fatal: not a git repository" in DevContainer
- Check if `.devcontainer/devcontainer.json` has git directory mount
- Run: `cat .git` (should show gitdir path)
- Verify: `echo $GIT_DIR` (should be set in container)
- Fix: Add mount for `../<main-repo>/.git` directory

### Worktree disappeared after reboot
```bash
cd ~/code/metr-repo
git worktree repair
```

### DevContainer name collision
- Check `.devcontainer/devcontainer.json` for hardcoded container name
- Update to use dynamic naming: `"name": "${localWorkspaceFolderBasename}"`
- Rebuild DevContainer

### Warp CLI not found
```bash
# Warp CLI is not installed by default
# If you want Warp tab integration, install Warp terminal first
# Otherwise, worktrees work fine without Warp
```

## Reference Files

Helper scripts and templates are available in:
- `~/.claude/skills/worktree/scripts/create-worktree.sh`
- `~/.claude/skills/worktree/scripts/cleanup-worktree.sh`
- `~/.claude/skills/worktree/templates/devcontainer.json`
